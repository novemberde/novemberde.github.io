<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Serverless + AWS Lambda + AWS CloudWatch + Slack 를 활용한 Web crawler 만들기 | Novemberde's Blog</title>
<meta name=keywords content="node,crawler,lambda,cloudWatch,slack,crawler,crawling,크롤링,got,cheerio,serverless"><meta name=description content="Summary 우리는 매일 각 웹사이트를 확인하여 뉴스를 취합한다. 별다른 요구사항 없이 직접 업무를 진행하시지만 이건 자동화해야된다는 생각이 들었다. 하루에 한 번 이뤄지는 일이니 주기적으로 슬랙에 최신 뉴스를 보내도록 자동화한다면 업무의 작은 시간도 아낄 수 있을 것이다. 그래서 이번에 크롤링 자동화 방법에 대해서 정리하려고 한다.
Serverless framework를 활용하면 빠른 배포 및 관리가 가능하니 기술 스택을 다음과 같이 정했다.
AWS Lambda: javascript로 작성. got, cheerio를 사용하여 crawler 설계 got: Request 모듈. 우리나라에는 많이 알려져있지 않지만 해외에서는 주로 got을 사용."><meta name=author content><link rel=canonical href=https://novemberde.github.io/post/2017/12/31/Node-crawler/><link crossorigin=anonymous href=/assets/css/stylesheet.min.9f1d947375927e9847272b1f4e9be81336f539e513bf04d52cade31f81cad1af.css integrity="sha256-nx2Uc3WSfphHJysfTpvoEzb1OeUTvwTVLK3jH4HK0a8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.30d2332871da51f600f574811c17751e6c862577d450b624f86e2bc8a6e31221.js integrity="sha256-MNIzKHHaUfYA9XSBHBd1HmyGJXfUULYk+G4ryKbjEiE=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://novemberde.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://novemberde.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://novemberde.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://novemberde.github.io/apple-touch-icon.png><link rel=mask-icon href=https://novemberde.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.123.7"><link rel=alternate hreflang=en href=https://novemberde.github.io/post/2017/12/31/Node-crawler/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9SF4VDQ4N0"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9SF4VDQ4N0",{anonymize_ip:!1})}</script><meta property="og:title" content="Serverless + AWS Lambda + AWS CloudWatch + Slack 를 활용한  Web crawler 만들기"><meta property="og:description" content="Summary 우리는 매일 각 웹사이트를 확인하여 뉴스를 취합한다. 별다른 요구사항 없이 직접 업무를 진행하시지만 이건 자동화해야된다는 생각이 들었다. 하루에 한 번 이뤄지는 일이니 주기적으로 슬랙에 최신 뉴스를 보내도록 자동화한다면 업무의 작은 시간도 아낄 수 있을 것이다. 그래서 이번에 크롤링 자동화 방법에 대해서 정리하려고 한다.
Serverless framework를 활용하면 빠른 배포 및 관리가 가능하니 기술 스택을 다음과 같이 정했다.
AWS Lambda: javascript로 작성. got, cheerio를 사용하여 crawler 설계 got: Request 모듈. 우리나라에는 많이 알려져있지 않지만 해외에서는 주로 got을 사용."><meta property="og:type" content="article"><meta property="og:url" content="https://novemberde.github.io/post/2017/12/31/Node-crawler/"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-12-31T11:30:03+00:00"><meta property="article:modified_time" content="2017-12-31T11:30:03+00:00"><meta property="og:site_name" content="Novemberde dev logs"><meta name=twitter:card content="summary"><meta name=twitter:title content="Serverless + AWS Lambda + AWS CloudWatch + Slack 를 활용한  Web crawler 만들기"><meta name=twitter:description content="Summary 우리는 매일 각 웹사이트를 확인하여 뉴스를 취합한다. 별다른 요구사항 없이 직접 업무를 진행하시지만 이건 자동화해야된다는 생각이 들었다. 하루에 한 번 이뤄지는 일이니 주기적으로 슬랙에 최신 뉴스를 보내도록 자동화한다면 업무의 작은 시간도 아낄 수 있을 것이다. 그래서 이번에 크롤링 자동화 방법에 대해서 정리하려고 한다.
Serverless framework를 활용하면 빠른 배포 및 관리가 가능하니 기술 스택을 다음과 같이 정했다.
AWS Lambda: javascript로 작성. got, cheerio를 사용하여 crawler 설계 got: Request 모듈. 우리나라에는 많이 알려져있지 않지만 해외에서는 주로 got을 사용."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://novemberde.github.io/post/"},{"@type":"ListItem","position":2,"name":"Serverless + AWS Lambda + AWS CloudWatch + Slack 를 활용한  Web crawler 만들기","item":"https://novemberde.github.io/post/2017/12/31/Node-crawler/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Serverless + AWS Lambda + AWS CloudWatch + Slack 를 활용한  Web crawler 만들기","name":"Serverless \u002b AWS Lambda \u002b AWS CloudWatch \u002b Slack 를 활용한  Web crawler 만들기","description":"Summary 우리는 매일 각 웹사이트를 확인하여 뉴스를 취합한다. 별다른 요구사항 없이 직접 업무를 진행하시지만 이건 자동화해야된다는 생각이 들었다. 하루에 한 번 이뤄지는 일이니 주기적으로 슬랙에 최신 뉴스를 보내도록 자동화한다면 업무의 작은 시간도 아낄 수 있을 것이다. 그래서 이번에 크롤링 자동화 방법에 대해서 정리하려고 한다.\nServerless framework를 활용하면 빠른 배포 및 관리가 가능하니 기술 스택을 다음과 같이 정했다.\nAWS Lambda: javascript로 작성. got, cheerio를 사용하여 crawler 설계 got: Request 모듈. 우리나라에는 많이 알려져있지 않지만 해외에서는 주로 got을 사용.","keywords":["node","crawler","lambda","cloudWatch","slack","crawler","crawling","크롤링","got","cheerio","serverless"],"articleBody":"Summary 우리는 매일 각 웹사이트를 확인하여 뉴스를 취합한다. 별다른 요구사항 없이 직접 업무를 진행하시지만 이건 자동화해야된다는 생각이 들었다. 하루에 한 번 이뤄지는 일이니 주기적으로 슬랙에 최신 뉴스를 보내도록 자동화한다면 업무의 작은 시간도 아낄 수 있을 것이다. 그래서 이번에 크롤링 자동화 방법에 대해서 정리하려고 한다.\nServerless framework를 활용하면 빠른 배포 및 관리가 가능하니 기술 스택을 다음과 같이 정했다.\nAWS Lambda: javascript로 작성. got, cheerio를 사용하여 crawler 설계 got: Request 모듈. 우리나라에는 많이 알려져있지 않지만 해외에서는 주로 got을 사용. npm에서 download 수가 압도적으로 많다. 사용법이 간단하다. cheerio: jQuery형식으로 서버에서 사용하는 모듈 AWS CloudWatch: 주기적으로 Lambda 함수를 실행하기 위함 Serverless framework: 내부적으로 Serverless Application Model 파일을 생성하여 CloudFormation으로 배포하는 것을 자동화 Slack bot: 정해진 시간이 지나고 다시 뉴스정보를 불러오고 싶을 때 사용한다. Lambda를 trigger하는 방법으로 사용 개발 환경 설정 이 과정은 npm version 5 이상을 사용하고 있다고 가정하고 시작한다. 만일 사용하고 있지 않다면 npm install -g npx 를 실행한다. npx는 해당 패키지 내에서 node_modules/.bin에 있는 명령어를 바로 사용할 수 있게 해준다.\n프로젝트 디렉터리를 생성하고 node project로 초기화한다.\n$ mkdir lambda-crawler-demo $ cd lambda-crawler-demo $ npm init -y 해당 프로젝트에 필요한 패키지를 설치한다.\n$ npm i -D serverless 위에서 serverless package를 Global로 설치하지 않고 dev-dependency에 넣는 이유는 나중에 다른 작업환경에서도 Serverless의 버전을 명확하게 하기 위함이다. 그렇지 않으면 1, 2년이 지난 후에는 환경이 달라져 Global로 설치했던 Serverless 버전을 찾아야한 하기 때문이다.\nServerless framework의 개발환경을 설정한다.\n# app이라는 디렉터리에 aws-nodejs의 템플릿을 기본으로 생성한다. $ npx serverless create --template aws-nodejs --path app serverless.yml이라는 파일을 다음과 같이 편집한다.\nservice 명: my-crawler stage: dev region: us-east-1 [app/serverless.yml] service: my-crawler provider: name: aws runtime: nodejs6.10 stage: dev region: us-east-1 profile: my-service memorySize: 128 functions: crawler: handler: handler.crawler events: - schedule: rate(1 day) handler.js를 다음과 같이 편집한다.\n[app/handler.js] 'use strict'; module.exports.crawler = (event, context, callback) =\u003e { const response = { statusCode: 200, body: JSON.stringify({ message: 'Go Serverless v1.0! Your function executed successfully!', input: event, }), }; callback(null, response); } 이제부터 모든 작업은 app 디렉터리에서 한다. serverless로 deploy를 하기 위해선 사전에 AWS Command line interface가 설치되어 있고 IAM user를 생성하여 등록해야한다. 아직 하지 않았다면 여기를 참고하여 설정한다.\n그리고 위에서 profile 설정을 해주었는데 기본적으로 aws configure로 설정하면 여러 service account을 매번 설정해주어야 하기 때문에 aws configure –profile [profile-name] 으로 설정하여 여러 계정 정보를 가지고 있는 경우에도 문제없이 작업할 수 있도록 한다.\n비지니스 로직을 작성하기 전에 배포가 되는지 확인한다.\n$ npx serverless deploy 배포가 다 되었다면 Lambda 콘솔로 이동하여 다음과 같이 나타나는지 확인한다.\nCloudWatch Events가 있다면 정상적으로 배포가 된 것이다. 주기적으로 실행하기 위해 CloudWatch Event를 사용한다.\nCrawler 작성하기 크롤링 개요는 다음과 같다.\ngot을 사용하여 네이버 메인에 있는 뉴스 5개를 가져온다. cheerio를 사용해서 해당 DOM을 찾아낸다. 크롤링된 데이터를 Slack에 보낸다. 현재 디렉터리에 모듈을 설치한다\n[app/] $ npm init -y $ npm i cheerio got got의 사용법은 다음과 같다.\nconst got = require('got'); got('https://www.naver.com').then(res =\u003e { console.log(res.body); }); got(\"POST_URL\", { method: \"post\", body: JSON.stringify({text: \"hi\"}) }, () =\u003e { }) got과 cheerio를 모두 사용하면 다음과 같다.\n네이버 메인 뉴스를 가져온다.\nconst got = require('got'); const cheerio = require('cheerio'); got('https://www.naver.com').then(res =\u003e { $ = cheerio.load(res.body); const result = $('.ca_item .ca_a'); console.log(result.text()); }); 이제 크롤링을 했으니 Slack으로 내용을 보내본다.\nSlack에 원하는 채널에 들어가서 Add an app을 클릭한다.\nIncoming WebHooks의 설정으로 들어가서 Webhook URL을 복사하여 저장해둔다.\nslack 설정은 모두가 다를 수 있으니 다음과 같이 파일을 작성한다.\n[app/slack.config.json] { \"URL\": \"Paste your slack url\" } 거의 다 왔다. 이제 handler.js를 다음과 같이 편집해준다.\n[app/handler.js] 'use strict'; const got = require('got'); const cheerio = require('cheerio'); const SLACK_URL = require('./slack.config.json').URL; module.exports.crawler = (event, context, callback) =\u003e { let result; return got('https://www.naver.com').then(res =\u003e { const $ = cheerio.load(res.body); result = $('.ca_item .ca_a'); return got(SLACK_URL, { method: \"post\", body: JSON.stringify({text: result.text()}) }); }).then(() =\u003e { const response = { statusCode: 200, body: JSON.stringify({ message: result.text(), }), }; callback(null, response); }); } 이제 배포하면 매일 주기적으로 슬랙 알람이 올 것이다.\n$ npx serverless deploy 삭제하기 한 번 배포해봤으니 삭제하여 과금되지 않도록 한다.\n$ serverless remove References https://serverless.com/ https://ko.wikipedia.org/wiki/%ED%86%A0%EC%96%B4 https://github.com/novemberde/lambda-crawler-demo https://www.npmjs.com/package/got https://www.npmjs.com/package/cheerio ","wordCount":"637","inLanguage":"en","datePublished":"2017-12-31T11:30:03Z","dateModified":"2017-12-31T11:30:03Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://novemberde.github.io/post/2017/12/31/Node-crawler/"},"publisher":{"@type":"Organization","name":"Novemberde's Blog","logo":{"@type":"ImageObject","url":"https://novemberde.github.io/favicon.ico"}}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8620431066400094" crossorigin=anonymous></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://novemberde.github.io/ accesskey=h title="Novemberde's Blog (Alt + H)">Novemberde's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=https://novemberde.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://novemberde.github.io/post/ title=Post><span>Post</span></a></li><li><a href=https://novemberde.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://novemberde.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://novemberde.github.io/post/>Posts</a></div><h1 class=post-title>Serverless + AWS Lambda + AWS CloudWatch + Slack 를 활용한 Web crawler 만들기</h1><div class=post-meta>December 31, 2017 3 min</div></header><div class=post-content><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><hr><p>우리는 매일 각 웹사이트를 확인하여 뉴스를 취합한다. 별다른 요구사항 없이 직접 업무를 진행하시지만 이건 자동화해야된다는 생각이 들었다.
하루에 한 번 이뤄지는 일이니 주기적으로 슬랙에 최신 뉴스를 보내도록 자동화한다면 업무의 작은 시간도 아낄 수 있을 것이다.
그래서 이번에 크롤링 자동화 방법에 대해서 정리하려고 한다.</p><p>Serverless framework를 활용하면 빠른 배포 및 관리가 가능하니 기술 스택을 다음과 같이 정했다.</p><ul><li>AWS Lambda: javascript로 작성. got, cheerio를 사용하여 crawler 설계<ul><li>got: Request 모듈. 우리나라에는 많이 알려져있지 않지만 해외에서는 주로 got을 사용. npm에서 download 수가 압도적으로 많다. 사용법이 간단하다.</li><li>cheerio: jQuery형식으로 서버에서 사용하는 모듈</li></ul></li><li>AWS CloudWatch: 주기적으로 Lambda 함수를 실행하기 위함</li><li>Serverless framework: 내부적으로 Serverless Application Model 파일을 생성하여 CloudFormation으로 배포하는 것을 자동화</li><li>Slack bot: 정해진 시간이 지나고 다시 뉴스정보를 불러오고 싶을 때 사용한다. Lambda를 trigger하는 방법으로 사용</li></ul><hr><h2 id=개발-환경-설정>개발 환경 설정<a hidden class=anchor aria-hidden=true href=#개발-환경-설정>#</a></h2><hr><p>이 과정은 npm version 5 이상을 사용하고 있다고 가정하고 시작한다.
만일 사용하고 있지 않다면 npm install -g npx 를 실행한다.
npx는 해당 패키지 내에서 node_modules/.bin에 있는 명령어를 바로 사용할 수 있게 해준다.</p><p>프로젝트 디렉터리를 생성하고 node project로 초기화한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ mkdir lambda-crawler-demo
</span></span><span style=display:flex><span>$ cd lambda-crawler-demo
</span></span><span style=display:flex><span>$ npm init -y
</span></span></code></pre></div><p>해당 프로젝트에 필요한 패키지를 설치한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ npm i -D serverless
</span></span></code></pre></div><p>위에서 serverless package를 Global로 설치하지 않고 dev-dependency에 넣는 이유는 나중에 다른 작업환경에서도
Serverless의 버전을 명확하게 하기 위함이다. 그렇지 않으면 1, 2년이 지난 후에는 환경이 달라져 Global로 설치했던
Serverless 버전을 찾아야한 하기 때문이다.</p><p>Serverless framework의 개발환경을 설정한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># app이라는 디렉터리에 aws-nodejs의 템플릿을 기본으로 생성한다.</span>
</span></span><span style=display:flex><span>$ npx serverless create --template aws-nodejs --path app
</span></span></code></pre></div><p>serverless.yml이라는 파일을 다음과 같이 편집한다.</p><ul><li>service 명: my-crawler</li><li>stage: dev</li><li>region: us-east-1</li></ul><h4 id=appserverlessyml>[app/serverless.yml]<a hidden class=anchor aria-hidden=true href=#appserverlessyml>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>service</span>: <span style=color:#ae81ff>my-crawler</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>runtime</span>: <span style=color:#ae81ff>nodejs6.10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>dev</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>profile</span>: <span style=color:#ae81ff>my-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>memorySize</span>: <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>functions</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>crawler</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>handler.crawler</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>events</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>schedule</span>: <span style=color:#ae81ff>rate(1 day)</span>
</span></span></code></pre></div><p>handler.js를 다음과 같이 편집한다.</p><h4 id=apphandlerjs>[app/handler.js]<a hidden class=anchor aria-hidden=true href=#apphandlerjs>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>crawler</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Go Serverless v1.0! Your function executed successfully!&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>input</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>,
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h3 id=이제부터-모든-작업은-app-디렉터리에서-한다>이제부터 모든 작업은 app 디렉터리에서 한다.<a hidden class=anchor aria-hidden=true href=#이제부터-모든-작업은-app-디렉터리에서-한다>#</a></h3><hr><p>serverless로 deploy를 하기 위해선 사전에 AWS Command line interface가 설치되어 있고
IAM user를 생성하여 등록해야한다. 아직 하지 않았다면 <a href=/aws/2017/08/14/Serverless.html>여기</a>를 참고하여 설정한다.</p><p>그리고 위에서 profile 설정을 해주었는데 기본적으로 aws configure로 설정하면
여러 service account을 매번 설정해주어야 하기 때문에 aws configure &ndash;profile [profile-name] 으로 설정하여
여러 계정 정보를 가지고 있는 경우에도 문제없이 작업할 수 있도록 한다.</p><p>비지니스 로직을 작성하기 전에 배포가 되는지 확인한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ npx serverless deploy
</span></span></code></pre></div><p>배포가 다 되었다면 <a href=https://console.aws.amazon.com/lambda/>Lambda 콘솔</a>로 이동하여 다음과 같이 나타나는지 확인한다.</p><p>CloudWatch Events가 있다면 정상적으로 배포가 된 것이다. 주기적으로 실행하기 위해 CloudWatch Event를 사용한다.</p><p><img loading=lazy src=/images/aws/lambda/crawler.png alt="CloudWatch Events"></p><hr><h2 id=crawler-작성하기>Crawler 작성하기<a hidden class=anchor aria-hidden=true href=#crawler-작성하기>#</a></h2><hr><p>크롤링 개요는 다음과 같다.</p><ol><li>got을 사용하여 네이버 메인에 있는 뉴스 5개를 가져온다.</li><li>cheerio를 사용해서 해당 DOM을 찾아낸다.</li><li>크롤링된 데이터를 Slack에 보낸다.</li></ol><p>현재 디렉터리에 모듈을 설치한다</p><h4 id=app>[app/]<a hidden class=anchor aria-hidden=true href=#app>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ npm init -y
</span></span><span style=display:flex><span>$ npm i cheerio got
</span></span></code></pre></div><p>got의 사용법은 다음과 같다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>got</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;got&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>got</span>(<span style=color:#e6db74>&#39;https://www.naver.com&#39;</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>res</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>got</span>(<span style=color:#e6db74>&#34;POST_URL&#34;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;post&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({<span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;hi&#34;</span>})
</span></span><span style=display:flex><span>}, () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>got과 cheerio를 모두 사용하면 다음과 같다.</p><p>네이버 메인 뉴스를 가져온다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>got</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;got&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cheerio</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;cheerio&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>got</span>(<span style=color:#e6db74>&#39;https://www.naver.com&#39;</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>res</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>$</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cheerio</span>.<span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;.ca_item .ca_a&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>text</span>());
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>이제 크롤링을 했으니 Slack으로 내용을 보내본다.</p><p>Slack에 원하는 채널에 들어가서 Add an app을 클릭한다.</p><p>Incoming WebHooks의 설정으로 들어가서 Webhook URL을 복사하여 저장해둔다.</p><p>slack 설정은 모두가 다를 수 있으니 다음과 같이 파일을 작성한다.</p><h4 id=appslackconfigjson>[app/slack.config.json]<a hidden class=anchor aria-hidden=true href=#appslackconfigjson>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;URL&#34;</span>: <span style=color:#e6db74>&#34;Paste your slack url&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>거의 다 왔다. 이제 handler.js를 다음과 같이 편집해준다.</p><h4 id=apphandlerjs-1>[app/handler.js]<a hidden class=anchor aria-hidden=true href=#apphandlerjs-1>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>got</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;got&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cheerio</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;cheerio&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>SLACK_URL</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./slack.config.json&#39;</span>).<span style=color:#a6e22e>URL</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>crawler</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>got</span>(<span style=color:#e6db74>&#39;https://www.naver.com&#39;</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>res</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>$</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cheerio</span>.<span style=color:#a6e22e>load</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;.ca_item .ca_a&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>got</span>(<span style=color:#a6e22e>SLACK_URL</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;post&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({<span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>text</span>()})
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  }).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>text</span>(),
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>이제 배포하면 매일 주기적으로 슬랙 알람이 올 것이다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ npx serverless deploy
</span></span></code></pre></div><hr><h2 id=삭제하기>삭제하기<a hidden class=anchor aria-hidden=true href=#삭제하기>#</a></h2><hr><p>한 번 배포해봤으니 삭제하여 과금되지 않도록 한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ serverless remove
</span></span></code></pre></div><hr><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><hr><ul><li><a href=https://serverless.com/>https://serverless.com/</a></li><li><a href=https://ko.wikipedia.org/wiki/%ED%86%A0%EC%96%B4>https://ko.wikipedia.org/wiki/%ED%86%A0%EC%96%B4</a></li><li><a href=https://github.com/novemberde/lambda-crawler-demo>https://github.com/novemberde/lambda-crawler-demo</a></li><li><a href=https://www.npmjs.com/package/got>https://www.npmjs.com/package/got</a></li><li><a href=https://www.npmjs.com/package/cheerio>https://www.npmjs.com/package/cheerio</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://novemberde.github.io/tags/node/>Node</a></li><li><a href=https://novemberde.github.io/tags/lambda/>Lambda</a></li><li><a href=https://novemberde.github.io/tags/cloudWatch/>CloudWatch</a></li><li><a href=https://novemberde.github.io/tags/slack/>Slack</a></li><li><a href=https://novemberde.github.io/tags/crawler/>Crawler</a></li><li><a href=https://novemberde.github.io/tags/crawling/>Crawling</a></li><li><a href=https://novemberde.github.io/tags/%ED%81%AC%EB%A1%A4%EB%A7%81/>크롤링</a></li><li><a href=https://novemberde.github.io/tags/got/>Got</a></li><li><a href=https://novemberde.github.io/tags/cheerio/>Cheerio</a></li><li><a href=https://novemberde.github.io/tags/serverless/>Serverless</a></li></ul><nav class=paginav><a class=prev href=https://novemberde.github.io/post/2018/01/20/ECS_Fargate/><span class=title>« Prev Page</span><br><span>ECS & Fargate Demo</span>
</a><a class=next href=https://novemberde.github.io/post/2017/12/19/Android-Webview/><span class=title>Next Page »</span><br><span>Android Webview에서 Javascript에러로 인해 뷰가 안나올 경우</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//novemberde-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://novemberde.github.io/>Novemberde's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>